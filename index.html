<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Get User Location - Tableau Extension</title>
 <script type="text/javascript" 
  src="./tableau.extensions.1.latest.min.js">
</script>
</head>
<body>
  <h2>Enter ZIP Code</h2>
  <input type="text" id="zipInput" placeholder="e.g. 10001" />
  <button id="fetchBirdsBtn">Fetch Birds</button>

<p id="locationStatus">Waiting for input...</p>
<p id="location"></p>
<ul id="birdList"></ul>

  <script>
    const output = document.getElementById('location');
    const log = (...args) => {
      console.log('[DEBUG]', ...args);
    };
    document.getElementById('fetchBirdsBtn').addEventListener('click', async () => {
    const zip = document.getElementById('zipInput').value.trim();
    const locationStatus = document.getElementById('locationStatus');
    const birdList = document.getElementById('birdList');
  
    if (!zip) {
      locationStatus.textContent = "‚ùó Please enter a ZIP code.";
      return;
    }

  locationStatus.textContent = "üìç Looking up location...";

  try {
    const geoRes = await fetch(`https://api.zippopotam.us/us/${zip}`);
    if (!geoRes.ok) throw new Error("Invalid ZIP");

    const geoData = await geoRes.json();
    const { latitude, longitude } = geoData.places[0];
    locationStatus.textContent = `üìç Lat: ${latitude}, Lon: ${longitude}`;

    // Now fetch birds from eBird
    const birdRes = await fetch(`https://api.ebird.org/v2/data/obs/geo/recent?back=5&dist=2&lat=${latitude}&lng=${longitude}`, {
      headers: {
        "X-eBirdApiToken": "2sfdah9jaj1k"
      }
    });

    const birdData = await birdRes.json();
    birdList.innerHTML = "";
    birdData.forEach(bird => {
      const li = document.createElement('li');
      li.textContent = `${bird.comName} seen at ${bird.locName}`;
      birdList.appendChild(li);
    });
  } catch (err) {
    locationStatus.textContent = "‚ùå Error: " + err.message;
  }
});


    // Run only if we're in Tableau
    if (window.tableau) {
      tableau.extensions.initializeAsync().then(() => {
        log('Running inside Tableau');
        getGeolocation();
      }).catch(err => {
        output.textContent = `Extension failed to initialize: ${err.message}`;
        log('Initialization error:', err);
      });
    } else {
      log('‚ö†Ô∏è Not running inside Tableau. Skipping initializeAsync.');
      output.textContent = "This extension must be run in Tableau.";
    }
  </script>
</body>
</html>
